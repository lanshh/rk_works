From 3fc37a1a4b4e6ba8872fded17809103da9aa1b82 Mon Sep 17 00:00:00 2001
From: lanshh <lsh@rock-chips.com>
Date: Fri, 12 Apr 2019 18:03:36 +0800
Subject: [PATCH] WireAccessoryManager: add DP SPDIF event monitor to support
 dp audio

Signed-off-by: lanshh <lsh@rock-chips.com>
---
 .../java/com/android/server/WiredAccessoryManager.java     | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/services/core/java/com/android/server/WiredAccessoryManager.java b/services/core/java/com/android/server/WiredAccessoryManager.java
index fcda83d..754b94f 100644
--- a/services/core/java/com/android/server/WiredAccessoryManager.java
+++ b/services/core/java/com/android/server/WiredAccessoryManager.java
@@ -60,14 +60,16 @@ final class WiredAccessoryManager implements WiredAccessoryCallbacks {
     private static final int BIT_USB_HEADSET_DGTL = (1 << 3);
     private static final int BIT_HDMI_AUDIO = (1 << 4);
     private static final int BIT_LINEOUT = (1 << 5);
+	private static final int BIT_SPDIF_OUT = (1 << 6);
     private static final int SUPPORTED_HEADSETS = (BIT_HEADSET|BIT_HEADSET_NO_MIC|
                                                    BIT_USB_HEADSET_ANLG|BIT_USB_HEADSET_DGTL|
-                                                   BIT_HDMI_AUDIO|BIT_LINEOUT);
+                                                   BIT_HDMI_AUDIO|BIT_LINEOUT|BIT_SPDIF_OUT);
 
     private static final String NAME_H2W = "h2w";
     private static final String NAME_USB_AUDIO = "usb_audio";
     private static final String NAME_HDMI_AUDIO = "hdmi_audio";
     private static final String NAME_HDMI = "hdmi";
+    private static final String NAME_DP = "cdn-dp";
 
     private static final int MSG_NEW_DEVICE_STATE = 1;
     private static final int MSG_SYSTEM_READY = 2;
@@ -279,6 +281,8 @@ final class WiredAccessoryManager implements WiredAccessoryCallbacks {
                 outDevice = AudioManager.DEVICE_OUT_DGTL_DOCK_HEADSET;
             } else if (headset == BIT_HDMI_AUDIO) {
                 outDevice = AudioManager.DEVICE_OUT_HDMI;
+            } else if (headset == BIT_SPDIF_OUT) {
+                outDevice = AudioManager.DEVICE_OUT_SPDIF;
             } else {
                 Slog.e(TAG, "setDeviceState() invalid headset type: "+headset);
                 return;
@@ -395,6 +399,14 @@ final class WiredAccessoryManager implements WiredAccessoryCallbacks {
                 }
             }
 
+	    // Monitor DP
+	    uei = new UEventInfo(NAME_DP, BIT_SPDIF_OUT, 0, 0);
+	    if (uei.checkSwitchExists()) {
+		retVal.add(uei);
+	    } else {
+		Slog.w(TAG, "This kernel does not have dp audio support");
+	    }
+
             return retVal;
         }
 
-- 
1.9.1

