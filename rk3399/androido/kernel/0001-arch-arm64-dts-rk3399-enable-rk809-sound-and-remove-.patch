From f1c1fe28460ad9f39fca2e7b2ae911053b221e05 Mon Sep 17 00:00:00 2001
From: lanshh <lsh@rock-chips.com>
Date: Tue, 2 Jul 2019 14:14:58 +0800
Subject: [PATCH] arch: arm64: dts: rk3399: enable rk809 sound and remove
 unused sound configs

---
 .../dts/rockchip/rk3399-excavator-sapphire.dtsi    | 44 ----------------------
 .../rockchip/rk3399-sapphire-excavator-edp.dtsi    | 16 +++-----
 arch/arm64/boot/dts/rockchip/rk3399-sapphire.dtsi  | 33 ++++++++++++++--
 arch/arm64/boot/dts/rockchip/rk3399.dtsi           |  5 +--
 4 files changed, 36 insertions(+), 62 deletions(-)

diff --git a/arch/arm64/boot/dts/rockchip/rk3399-excavator-sapphire.dtsi b/arch/arm64/boot/dts/rockchip/rk3399-excavator-sapphire.dtsi
index cb8292e..d7a3293 100644
--- a/arch/arm64/boot/dts/rockchip/rk3399-excavator-sapphire.dtsi
+++ b/arch/arm64/boot/dts/rockchip/rk3399-excavator-sapphire.dtsi
@@ -45,50 +45,6 @@
 / {
 	compatible = "rockchip,rk3399-sapphire-excavator", "rockchip,rk3399";
 
-	dummy_codec: dummy-codec {
-		status = "disabled";
-		compatible = "rockchip,dummy-codec";
-		#sound-dai-cells = <0>;
-		clocks = <&cru SCLK_I2S_8CH_OUT>;
-		clock-names = "mclk";
-		pinctrl-names = "default";
-		pinctrl-0 = <&i2s_8ch_mclk>;
-	};
-
-	rockchip_i2s_sound: rockchip-i2s-sound {
-		status = "disabled";
-		compatible = "simple-audio-card";
-		simple-audio-card,name = "rockchip,rockchip-i2s-sound";
-		simple-audio-card,format = "i2s";
-		simple-audio-card,mclk-fs = <256>;
-		simple-audio-card,cpu {
-			sound-dai = <&i2s0>;
-		};
-		simple-audio-card,codec {
-			sound-dai = <&dummy_codec>;
-		};
-	};
-
-	rt5651-sound {
-		compatible = "simple-audio-card";
-		simple-audio-card,format = "i2s";
-		simple-audio-card,name = "realtek,rt5651-codec";
-		simple-audio-card,mclk-fs = <256>;
-		simple-audio-card,widgets =
-			"Microphone", "Mic Jack",
-			"Headphone", "Headphone Jack";
-		simple-audio-card,routing =
-			"Mic Jack", "MICBIAS1",
-			"IN1P", "Mic Jack",
-			"Headphone Jack", "HPOL",
-			"Headphone Jack", "HPOR";
-		simple-audio-card,cpu {
-			sound-dai = <&i2s0>;
-		};
-		simple-audio-card,codec {
-			sound-dai = <&rt5651>;
-		};
-	};
 
 	spdif-sound {
 		status = "okay";
diff --git a/arch/arm64/boot/dts/rockchip/rk3399-sapphire-excavator-edp.dtsi b/arch/arm64/boot/dts/rockchip/rk3399-sapphire-excavator-edp.dtsi
index 10994d0..cc7f921 100644
--- a/arch/arm64/boot/dts/rockchip/rk3399-sapphire-excavator-edp.dtsi
+++ b/arch/arm64/boot/dts/rockchip/rk3399-sapphire-excavator-edp.dtsi
@@ -103,18 +103,12 @@
 		status = "disabled";
 	};
 
-wireless-bluetooth {
-    status = "okay";
-    BT,wake_gpio = <&gpio0 4 GPIO_ACTIVE_HIGH>; /* GPIO2_D2 */
-    BT,wake_host_irq = <&gpio2 27 GPIO_ACTIVE_HIGH>; /* GPIO0_A4 */
-};
-
-	hdmiin-sound {
-		compatible = "rockchip,rockchip-rt5651-tc358749x-sound";
-		rockchip,cpu = <&i2s0>;
-		rockchip,codec = <&rt5651 &rt5651 &tc358749x>;
+	wireless-bluetooth {
 		status = "okay";
+		BT,wake_gpio = <&gpio0 4 GPIO_ACTIVE_HIGH>; /* GPIO2_D2 */
+		BT,wake_host_irq = <&gpio2 27 GPIO_ACTIVE_HIGH>; /* GPIO0_A4 */
 	};
+
 };
 
 &backlight {
@@ -155,7 +149,7 @@ wireless-bluetooth {
 };
 
 &rt5651 {
-	status = "okay";
+	status = "disabled";
     hp-det-gpio = <&gpio0 11 GPIO_ACTIVE_LOW>;
 };
 
diff --git a/arch/arm64/boot/dts/rockchip/rk3399-sapphire.dtsi b/arch/arm64/boot/dts/rockchip/rk3399-sapphire.dtsi
index 42f73e8..ade2217 100755
--- a/arch/arm64/boot/dts/rockchip/rk3399-sapphire.dtsi
+++ b/arch/arm64/boot/dts/rockchip/rk3399-sapphire.dtsi
@@ -99,6 +99,26 @@
 		compatible = "rockchip,dw-hdmi-audio";
 		#sound-dai-cells = <0>;
 	};
+	rk809_sound: rk809-sound {
+		compatible = "simple-audio-card";
+		simple-audio-card,format = "i2s";
+		simple-audio-card,name = "rockchip,rk809-codec";
+		simple-audio-card,mclk-fs = <256>;
+		simple-audio-card,widgets =
+			"Microphone", "Mic Jack",
+			"Headphone", "Headphone Jack";
+		simple-audio-card,routing =
+			"Mic Jack", "MICBIAS1",
+			"IN1P", "Mic Jack",
+			"Headphone Jack", "HPOL",
+			"Headphone Jack", "HPOR";
+		simple-audio-card,cpu {
+			sound-dai = <&i2s1>;
+		};
+		simple-audio-card,codec {
+			sound-dai = <&rk809_codec>;
+		};
+	};
 
 	dp_sound: dp-sound {
 		status = "disabled";
@@ -563,18 +583,20 @@
 				};
 	        };
 
-            rk809_codec: codec {
+        };
+		rk809_codec: codec {
 			#sound-dai-cells = <0>;
 			compatible = "rockchip,rk809-codec", "rockchip,rk817-codec";
 			clocks = <&cru SCLK_I2S_8CH_OUT>;
 			clock-names = "mclk";
 			pinctrl-names = "default";
 			pinctrl-0 = <&i2s_8ch_mclk>;
+			assigned-clocks = <&cru SCLK_I2SOUT_SRC>;
+			assigned-clock-parents = <&cru SCLK_I2S1_8CH>;
 			hp-volume = <20>;
 			spk-volume = <3>;
 			status = "okay";
-		    };
-        };
+		};
     };
 };
 
@@ -602,6 +624,11 @@
 	#sound-dai-cells = <0>;
 };
 
+&i2s1 {
+    #sound-dai-cells = <0>;
+    status = "okay";
+};
+
 &i2s2 {
 	#sound-dai-cells = <0>;
 	status = "okay";
diff --git a/arch/arm64/boot/dts/rockchip/rk3399.dtsi b/arch/arm64/boot/dts/rockchip/rk3399.dtsi
index f0d2644..3b2d4e1 100644
--- a/arch/arm64/boot/dts/rockchip/rk3399.dtsi
+++ b/arch/arm64/boot/dts/rockchip/rk3399.dtsi
@@ -2537,12 +2537,10 @@
 				rockchip,pins =
 					<3 24 RK_FUNC_1 &pcfg_pull_none>,
 					<3 25 RK_FUNC_1 &pcfg_pull_none>,
-					<3 26 RK_FUNC_1 &pcfg_pull_none>,
 					<3 27 RK_FUNC_1 &pcfg_pull_none>,
 					<3 28 RK_FUNC_1 &pcfg_pull_none>,
 					<3 29 RK_FUNC_1 &pcfg_pull_none>,
-					<3 30 RK_FUNC_1 &pcfg_pull_none>,
-					<3 31 RK_FUNC_1 &pcfg_pull_none>;
+					<3 30 RK_FUNC_1 &pcfg_pull_none>;
 			};
 
 			i2s_8ch_mclk: i2s-8ch-mclk {
@@ -2555,7 +2553,6 @@
 				rockchip,pins =
 					<4 3 RK_FUNC_1 &pcfg_pull_none>,
 					<4 4 RK_FUNC_1 &pcfg_pull_none>,
-					<4 5 RK_FUNC_1 &pcfg_pull_none>,
 					<4 6 RK_FUNC_1 &pcfg_pull_none>,
 					<4 7 RK_FUNC_1 &pcfg_pull_none>;
 			};
-- 
1.9.1

